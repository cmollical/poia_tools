<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Client Recruitment List Generation & Scrubbing</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* GLOBAL STYLES */
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Arial, sans-serif; background-color: #f9f9f9; color: #333; display: flex; flex-direction: column; align-items: center; padding-bottom: 70px; /* Added padding for logo */ position: relative; min-height: 100vh; }
    input[type="text"], textarea, input[type="number"], select { font-family: Arial, sans-serif; }
    a { text-decoration: none; color: inherit; } /* Basic link reset */

    /* HEADER */
    .header {
      display: flex; /* Use flexbox */
      justify-content: space-between; /* Space out items */
      align-items: center; /* Vertically align */
      padding: 10px 20px;
      background: #4e2d82;
      color: #fff;
      width: 100%;
      position: relative;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .header h1 {
      margin: 0; /* Remove auto margins */
      font-size: 1.6em; /* Consistent size */
      font-weight: 700;
      text-shadow: 1px 1px 4px rgba(0,0,0,0.3);
      text-align: center; /* Center heading */
      flex-grow: 1; /* Allow heading to take available space */
      /* No specific margins needed with space-between and flex-basis */
    }
    /* Containers for buttons to reserve space */
    .header .header-buttons-left,
    .header .header-buttons-right {
        flex-basis: 180px; /* Adjust width as needed for button/link */
        flex-shrink: 0; /* Prevent shrinking */
    }
     .header .header-buttons-left {
         text-align: left; /* Align content (link) to the left */
     }
    .header .header-buttons-right {
        text-align: right; /* Align content (button) to the right */
    }

    /* Style for the Back to Home link */
    .nav-link {
        color: #fff;
        background-color: #6c757d; /* Grey background */
        padding: 8px 15px;
        border-radius: 4px;
        font-size: 14px;
        transition: background-color 0.2s;
        border: 1px solid #fff;
        text-decoration: none;
        display: inline-block; /* Needed for padding/border */
        white-space: nowrap;
    }
    .nav-link:hover {
        background-color: #5a6268;
        text-decoration: none;
        color: #fff;
    }

    /* Style for the scrub button (now on right) */
    #scrubListButton {
        background-color: #4e2d82; /* Purple color */
        color: #fff;
        border: 1px solid #fff;
        padding: 8px 16px;
        cursor: pointer;
        border-radius: 4px;
        font-size: 14px;
        transition: background-color 0.2s, color 0.2s;
        white-space: nowrap;
        /* Removed absolute positioning */
    }
    #scrubListButton:hover {
      background-color: #fff; /* White background on hover */
      color: #4e2d82; /* Purple text on hover */
    }

    /* AI PROCESS FLOW VISUALIZATION */
    .ai-flow { max-width: 1200px; width: 100%; background: #fff; padding: 4px 8px; margin: 20px auto 5px auto; border-radius: 8px; box-shadow: 0 3px 8px rgba(0,0,0,0.1); display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; }
    .ai-flow h2 { width: 100%; text-align: center; margin: 10px 0 10px; color: #4e2d82; font-size: 16px; }
    .ai-step { display: flex; flex-direction: column; align-items: center; font-size: 12px; max-width: 150px; text-align: center; margin: 5px; }
    .ai-step .icon { width: 30px; height: 30px; background: #4e2d82; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-bottom: 4px; }
    .ai-arrow { font-size: 18px; color: #4e2d82; margin: 0 5px; align-self: center; }

    /* MAIN CONTENT CONTAINER */
    .main-content { max-width: 1200px; width: 100%; margin: 5px auto; padding: 0 10px; padding-bottom: 70px; }

    /* FULL-WIDTH BOX FOR THE PROMPT */
    .full-width-box { background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 3px 8px rgba(0,0,0,0.1); margin-bottom: 10px; }
    .full-width-box label { display: block; margin-bottom: 5px; font-weight: 500; color: #555; }
    .full-width-box textarea { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%; min-height: 90px; resize: vertical; }

    /* GRID FOR THE THREE COLUMNS BELOW THE PROMPT */
    .columns-container { display: grid; grid-template-columns: 350px 400px 1fr; gap: 10px; }

    /* LEFT COLUMN (FILTERS) */
    .filter-column { background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 3px 8px rgba(0,0,0,0.1); display: flex; flex-direction: column; height: 550px; overflow-y: auto; }
    .filter-column h3 { margin-top: 0; color: #4e2d82; font-size: 1.1em; margin-bottom: 15px; }
    .filter-group { margin-bottom: 15px; }
    .filter-group > label:not(.checkbox-item) { display: block; margin-bottom: 8px; color: #333; font-size: 14px; font-weight: bold; }
    .filter-group input[type="number"] { padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 80px; margin-bottom: 5px; display: block; }
    .checkbox-item { display: block; margin-bottom: 6px; font-weight: normal; color: #555; font-size: 13px; cursor: pointer; line-height: 1.3; }
    .checkbox-item input[type="checkbox"] { margin-right: 8px; vertical-align: middle; width: 15px; height: 15px; }

    /* MIDDLE COLUMN (FORM FIELDS & SUBMIT) */
    .form-column { background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 3px 8px rgba(0,0,0,0.1); display: flex; flex-direction: column; min-height: 550px; position: relative; }
    .form-column label { margin-bottom: 5px; font-weight: 500; color: #555; font-size: 14px; }
    .form-column input[type="text"], .form-column textarea, .form-column select { padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%; }
    .form-column textarea { resize: vertical; min-height: 150px; }

    /* FILE NAME FIELDS */
    .file-name-container { display: flex; gap: 10px; margin-bottom: 10px; }
    .file-name-container > div { display: flex; flex-direction: column; flex: 1; }
    .file-name-container > div:nth-child(1) { flex-basis: 45%; } .file-name-container > div:nth-child(2) { flex-basis: 30%; } .file-name-container > div:nth-child(3) { flex-basis: 25%; }
    .file-name-container label { margin-bottom: 3px; font-weight: 500; color: #555; white-space: nowrap; font-size: 13px; }
    .file-name-container input[type="text"], .file-name-container select { padding: 6px; font-size: 13px; }

    .button-container { display: flex; gap: 10px; margin-top: auto; padding-top: 10px; }
    .form-column button[type="submit"] { background-color: #4e2d82; color: #fff; padding: 10px 20px; font-size: 16px; font-weight: bold; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s ease; width: 100%; }
    .form-column button[type="submit"]:hover { background-color: #3c2369; }

    /* RIGHT COLUMN (EXAMPLE PROMPTS) */
    .info-column { background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 3px 8px rgba(0,0,0,0.1); max-height: 550px; overflow-y: auto; font-size: 13px; }
    .info-column h2 { margin-top: 0; color: #4e2d82; font-size: 1.1em; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
    .info-column table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .info-column th, .info-column td { border: 1px solid #ddd; padding: 6px; vertical-align: top; }
    .info-column th { background-color: #f2f2f2; color: #4e2d82; }

    /* CONFIRMATION & ERROR MESSAGES */
    #finalMessage, #errorMessage { display: none; margin: 15px auto; padding: 10px 15px; border-radius: 4px; font-size: 14px; font-weight: 500; text-align: center; max-width: 600px; }
    #finalMessage { color: #155724; background-color: #d4edda; border: 1px solid #c3e6cb; }
    #finalMessage a { color: #0056b3; text-decoration: underline; }
    #errorMessage { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; }

    /* RESET BUTTON */
    #resetButton { display: none; margin: 10px auto; padding: 8px 16px; font-size: 14px; background-color: #6c757d; color: #fff; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s ease; }
    #resetButton:hover { background-color: #5a6268; }

    /* LOGO */
    .logo-container { position: fixed; bottom: 10px; right: 10px; z-index: 999; }
    .logo-container img { width: 120px; height: auto; opacity: 0.8; }

    /* LOADING SCREEN STYLING */
    .loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: none; align-items: center; justify-content: center; flex-direction: column; z-index: 9999; }
    .spinner { border: 8px solid #ccc; border-top: 8px solid #4e2d82; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin-bottom: 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .step { font-size: 16px; color: #fff; opacity: 0; transition: opacity 0.5s; text-align: center; max-width: 80%; line-height: 1.4; }
    .step.active { opacity: 1; }

    /* --- MODAL STYLES --- */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; justify-content: center; align-items: center; padding: 20px; }
    .modal .modal-content { background: #fff; padding: 20px; border-radius: 8px; width: 90%; max-width: 700px; text-align: left; box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-height: 85vh; display: flex; flex-direction: column; }
    .modal .modal-content h3 { margin-top: 0; font-size: 18px; margin-bottom: 15px; color: #4e2d82; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .modal .modal-table-container { overflow-y: auto; margin-bottom: 15px; flex-grow: 1; min-height: 100px; }
    .modal table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .modal th, .modal td { border: 1px solid #ddd; padding: 8px 10px; vertical-align: middle; text-align: left; }
    .modal th { background-color: #f8f9fa; color: #495057; font-weight: 600; position: sticky; top: 0; z-index: 1; }
    .modal tr:nth-child(even) { background-color: #fdfdfe; } .modal tr:hover { background-color: #e9ecef; }
    .modal td { word-break: break-word; }
    .modal .modal-actions { display: flex; justify-content: space-between; gap: 10px; padding-top: 15px; border-top: 1px solid #eee; align-items: center; }
    .modal .modal-actions-right { display: flex; gap: 10px; }
    .modal .modal-button { background-color: #4e2d82; color: #fff; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; transition: background-color 0.2s; }
    .modal .modal-button:hover { background-color: #3c2369; }
    .modal .modal-button.secondary { background-color: #6c757d; }
    .modal .modal-button.secondary:hover { background-color: #5a6268; }
    .modal .selectListBtn { font-size: 12px; padding: 5px 10px; background-color: #28a745; }
    .modal .selectListBtn:hover { background-color: #218838; }

    /* --- Search Modal Specific Styles --- */
    #searchListModal .modal-content { max-width: 800px; }
    .modal .search-criteria { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 0; align-items: end; }
    .modal .search-criteria > div { display: flex; flex-direction: column; }
    .modal .search-criteria label { font-size: 13px; margin-bottom: 5px; display: block; color: #555; font-weight: 500; }
    .modal .search-criteria input, .modal .search-criteria select { width: 100%; padding: 8px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; }
    .modal .search-actions { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
    #searchOtherListsBtn { padding: 8px 20px; height: 37px; align-self: flex-end; }
    .modal .search-error { color: #dc3545; font-size: 13px; font-weight: 500; margin-top: 10px; min-height: 1.2em; text-align: left; }

    /* --- REPRESENTATIVE SAMPLE MODAL --- */
    #repSampleModal .modal-content { max-width: 320px; text-align: center; }
    #repSampleModal .modal-content h3 { text-align: center; }
    #repSampleForm { margin-top: 15px; margin-bottom: 15px; }
    #repSampleForm div { text-align: left; margin-bottom: 8px; }
    #repSampleForm input[type="checkbox"] { margin-right: 8px; vertical-align: middle; }
    #repSampleForm label { font-weight: normal; font-size: 14px; vertical-align: middle; }
    #repSampleModal .modal-content button { margin: 10px auto 0; display: block; }

    /* --- TEMPLATE SELECTION MODAL --- */
    #templateSelectModal .modal-content { max-width: 450px; }
    #templateSelectForm { margin: 15px 0; }
    #templateSelectForm .template-option { display: block; margin-bottom: 12px; cursor: pointer; }
    #templateSelectForm .template-option input[type="radio"] { margin-right: 10px; vertical-align: middle; width: 16px; height: 16px; }
    #templateSelectForm .template-option label { font-size: 15px; vertical-align: middle; color: #333; }
    #templateSelectModal .modal-actions { justify-content: flex-end; } /* Align buttons right */

    /* --- SCRUB MODAL STYLES --- */
    #scrubListModal .modal-content { max-width: 900px; max-height: 90vh; }
    #scrubListModal form { display: grid; grid-template-columns: 350px 1fr; gap: 20px; margin-top: 15px; flex-grow: 1; overflow-y: hidden; }
    #scrubListModal .modal-filter-column { height: auto; max-height: calc(85vh - 150px); overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 4px; background: #fff; box-shadow: none; }
    #scrubListModal .modal-filter-column h3 { margin-top: 0; color: #4e2d82; font-size: 1.1em; margin-bottom: 15px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
    #scrubListModal .modal-input-column { display: flex; flex-direction: column; gap: 10px; max-height: calc(85vh - 150px); overflow-y: auto; padding-right: 5px; }
    #scrubListModal .modal-input-column label { margin-bottom: 3px; font-weight: 500; color: #555; font-size: 14px; }
    #scrubListModal .modal-input-column input[type="text"], #scrubListModal .modal-input-column select, #scrubListModal .modal-input-column textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
    #scrubListModal .modal-input-column textarea { min-height: 150px; resize: vertical; flex-grow: 1; }
    #scrubListModal .file-name-container { margin-bottom: 0; }
    #scrubListModal .modal-actions { margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }
    #scrubGeneratedPrompt { margin-top: 10px; padding: 8px; background-color: #f0f0f0; border: 1px dashed #ccc; border-radius: 4px; font-size: 12px; color: #555; min-height: 50px; word-wrap: break-word; white-space: pre-wrap; font-family: monospace; }
    #scrubErrorMsg { color: #dc3545; font-size: 13px; font-weight: 500; margin-top: 5px; min-height: 1.2em; text-align: left; }

  </style>
</head>
<body>
  <!-- HEADER - UPDATED -->
  <div class="header">
    <div class="header-buttons-left">
        <a href="/" class="nav-link">Back to Home</a> <!-- Added Back Button -->
    </div>
    <h1>List Generation & Scrubbing</h1> <!-- Updated title -->
    <div class="header-buttons-right">
        <button id="scrubListButton">Scrub Existing List</button> <!-- Moved Scrub Button -->
    </div>
  </div>

  <!-- AI PROCESS FLOW -->
   <div class="ai-flow">
    <h2>What Happens When You Submit?</h2>
    <div class="ai-step"><div class="icon">1</div><div class="text">Prioritizes clients interested via Success Community.</div></div>
    <div class="ai-arrow">→</div>
    <div class="ai-step"><div class="icon">2</div><div class="text">Excludes previously invited clients for this feature.</div></div>
    <div class="ai-arrow">→</div>
    <div class="ai-step"><div class="icon">3</div><div class="text">Gathers additional clients matching filters/proportions.</div></div>
    <div class="ai-arrow">→</div>
    <div class="ai-step"><div class="icon">4</div><div class="text">Finalizes the list and prepares the output file.</div></div>
  </div>

  <!-- MAIN CONTENT (Original Form) -->
  <div class="main-content">
    <form id="recruitmentForm" autocomplete="off">
      <!-- PROMPT BOX -->
      <div class="full-width-box">
        <label for="var2">Tell me about your list:</label>
        <textarea id="var2" name="var2" required rows="3">Please give me xx contexts</textarea>
      </div>

      <!-- THREE COLUMN GRID -->
      <div class="columns-container">

        <!-- LEFT COLUMN (FILTERS) -->
        <div class="filter-column" id="mainFilterColumn">
          <h3>Interactive Request Generator</h3>
          <div class="filter-group" id="contextNumber-group"> <label for="numContexts">Number of Contexts:</label> <input type="number" id="numContexts" name="numContexts" placeholder="e.g., 60"> <label class="checkbox-item"><input type="checkbox" id="repSample" name="repSample"> Representative Sample</label> </div>
          <div class="filter-group" id="csmTier-group"> <label>CSM Tier:</label> <label class="checkbox-item"><input type="checkbox" value="Enterprise"> Enterprise</label> <label class="checkbox-item"><input type="checkbox" value="Hospital"> Hospital</label> <label class="checkbox-item"><input type="checkbox" value="Small Group"> Small Group</label> <label class="checkbox-item"><input type="checkbox" value="Group"> Group</label> </div>
          <div class="filter-group" id="csTeam-group"> <label>CS Team:</label> <label class="checkbox-item"><input type="checkbox" value="Enterprise"> Enterprise</label> <label class="checkbox-item"><input type="checkbox" value="Hospital"> Hospital</label> <label class="checkbox-item"><input type="checkbox" value="Top 25 Client"> Top 25 Client</label> <label class="checkbox-item"><input type="checkbox" value="Small Group"> Small Group</label> <label class="checkbox-item"><input type="checkbox" value="Group"> Group</label> <label class="checkbox-item"><input type="checkbox" value="Small Group - Specialist"> Small Group - Specialist</label> <label class="checkbox-item"><input type="checkbox" value="Small Group - 1st Year Live"> Small Group - 1st Year Live</label> </div>
          <div class="filter-group" id="clientRelType-group"> <label>Client Relationship Type:</label> <label class="checkbox-item"><input type="checkbox" value="Dental Beta Coordinator"> Dental Beta Coordinator</label> <label class="checkbox-item"><input type="checkbox" value="Clinical Performance Beta Coordinator – Quality"> Clinical Performance Beta Coordinator – Quality</label> <label class="checkbox-item"><input type="checkbox" value="Rev Cycle Beta Coordinator – Auth Management"> Rev Cycle Beta Coordinator – Auth Management</label> <label class="checkbox-item"><input type="checkbox" value="Patient Relations Beta Coordinator"> Patient Relations Beta Coordinator</label> <label class="checkbox-item"><input type="checkbox" value="Clinical Performance Beta Coordinator – Clinical Admin/IT"> Clinical Performance Beta Coordinator – Clinical Admin/IT</label> <label class="checkbox-item"><input type="checkbox" value="Pop Health Beta Coordinator"> Pop Health Beta Coordinator</label> <label class="checkbox-item"><input type="checkbox" value="Hospital Beta Coordinator"> Hospital Beta Coordinator</label> <label class="checkbox-item"><input type="checkbox" value="Rev Cycle Beta Coordinator"> Rev Cycle Beta Coordinator</label> <label class="checkbox-item"><input type="checkbox" value="Patient Relations Beta Coordinator – Clinicals"> Patient Relations Beta Coordinator – Clinicals</label> <label class="checkbox-item"><input type="checkbox" value="Rev Cycle Beta Coordinator - Billing"> Rev Cycle Beta Coordinator - Billing</label> <label class="checkbox-item"><input type="checkbox" value="Rev Cycle Beta Coordinator – Front Office"> Rev Cycle Beta Coordinator – Front Office</label> <label class="checkbox-item"><input type="checkbox" value="Clinical Performance Beta Coordinator – Clinical Workflow"> Clinical Performance Beta Coordinator – Clinical Workflow</label> <label class="checkbox-item"><input type="checkbox" value="Clinical Performance Beta Coordinator"> Clinical Performance Beta Coordinator</label> </div>
          <div class="filter-group" id="specialty-group"> <label>Specialty:</label> <label class="checkbox-item"><input type="checkbox" value="Family Practice"> Family Practice</label> <label class="checkbox-item"><input type="checkbox" value="Multi Specialty"> Multi Specialty</label> <label class="checkbox-item"><input type="checkbox" value="Internal Medicine"> Internal Medicine</label> <label class="checkbox-item"><input type="checkbox" value="Obstetrics/Gynecology"> Obstetrics/Gynecology</label> <label class="checkbox-item"><input type="checkbox" value="Pediatrics"> Pediatrics</label> <label class="checkbox-item"><input type="checkbox" value="Urgent Care"> Urgent Care</label> <label class="checkbox-item"><input type="checkbox" value="Orthopedic Surgery"> Orthopedic Surgery</label> <label class="checkbox-item"><input type="checkbox" value="Podiatry"> Podiatry</label> <label class="checkbox-item"><input type="checkbox" value="Pain Management Specialist"> Pain Management Specialist</label> <label class="checkbox-item"><input type="checkbox" value="Cardiology"> Cardiology</label> <label class="checkbox-item"><input type="checkbox" value="Behavioral Health"> Behavioral Health</label> <label class="checkbox-item"><input type="checkbox" value="Psychiatry"> Psychiatry</label> <label class="checkbox-item"><input type="checkbox" value="Neurology"> Neurology</label> <label class="checkbox-item"><input type="checkbox" value="Ophthalmology"> Ophthalmology</label> <label class="checkbox-item"><input type="checkbox" value="General Surgery"> General Surgery</label> </div>
          <div class="filter-group" id="clinicalsStatus-group"> <label>Clinicals Status:</label> <label class="checkbox-item"><input type="checkbox" value="Contract Change"> Contract Change</label> <label class="checkbox-item"><input type="checkbox" value="Live"> Live</label> <label class="checkbox-item"><input type="checkbox" value="Pre-Live"> Pre-Live</label> <label class="checkbox-item"><input type="checkbox" value="Live: Termination Pending"> Live: Termination Pending</label> <label class="checkbox-item"><input type="checkbox" value="Terminated"> Terminated</label> <label class="checkbox-item"><input type="checkbox" value="Chargeback"> Chargeback</label> </div>
          <div class="filter-group" id="collectorStatus-group"> <label>Collector Status:</label> <label class="checkbox-item"><input type="checkbox" value="Live"> Live</label> <label class="checkbox-item"><input type="checkbox" value="Pre-Live"> Pre-Live</label> <label class="checkbox-item"><input type="checkbox" value="Live: Termination Pending"> Live: Termination Pending</label> <label class="checkbox-item"><input type="checkbox" value="Terminated"> Terminated</label> <label class="checkbox-item"><input type="checkbox" value="Chargeback"> Chargeback</label> </div>
          <div class="filter-group" id="communicatorStatus-group"> <label>Communicator Status:</label> <label class="checkbox-item"><input type="checkbox" value="Live"> Live</label> <label class="checkbox-item"><input type="checkbox" value="Pre-Live"> Pre-Live</label> <label class="checkbox-item"><input type="checkbox" value="Live: Termination Pending"> Live: Termination Pending</label> <label class="checkbox-item"><input type="checkbox" value="Chargeback"> Chargeback</label> <label class="checkbox-item"><input type="checkbox" value="Terminated"> Terminated</label> </div>
          <div class="filter-group" id="hospitalClinicalsStatus-group"> <label>Hospital Clinicals Status:</label> <label class="checkbox-item"><input type="checkbox" value="Live"> Live</label> <label class="checkbox-item"><input type="checkbox" value="Terminated"> Terminated</label> <label class="checkbox-item"><input type="checkbox" value="Chargeback"> Chargeback</label> </div>
          <div class="filter-group" id="hospitalCollectorStatus-group"> <label>Hospital Collector Status:</label> <label class="checkbox-item"><input type="checkbox" value="Live"> Live</label> <label class="checkbox-item"><input type="checkbox" value="Terminated"> Terminated</label> <label class="checkbox-item"><input type="checkbox" value="Chargeback"> Chargeback</label> </div>
          <div class="filter-group" id="alphaBetaStatus-group"> <label>Alpha Beta Status:</label> <label class="checkbox-item"><input type="checkbox" value="CSM Sends Alpha/Beta Invites"> CSM Sends Alpha/Beta Invites</label> <label class="checkbox-item"><input type="checkbox" value="Contact Account Manager First"> Contact Account Manager First</label> <label class="checkbox-item"><input type="checkbox" value="Can Contact Client Directly"> Can Contact Client Directly</label> </div>
        </div> <!-- End mainFilterColumn -->

        <!-- MIDDLE COLUMN -->
        <div class="form-column">
          <label for="var1">Username (e.g., wwhite):</label>
          <input type="text" id="var1" name="var1" required>
          <div class="file-name-container">
            <div><label for="featureNumber">Feature Number:</label><input type="text" id="featureNumber" name="featureNumber" placeholder="FEATURE-123" required pattern="FEATURE-\d{3,8}"></div>
            <div><label for="stage">Stage:</label><select id="stage" name="stage" required><option value="Alpha">Alpha</option><option value="Beta">Beta</option><option value="DarkAlpha">DarkAlpha</option><option value="DarkBeta">DarkBeta</option><option value="AlphaBundled">AlphaBundled</option><option value="BetaBundled">BetaBundled</option><option value="AlphaBatched">AlphaBatched</option><option value="BetaBatched">BetaBatched</option></select></div>
            <div><label for="waveNumber">Wave Number:</label><select id="waveNumber" name="waveNumber" required><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option></select></div>
          </div>
          <input type="hidden" id="var3" name="var3">
          <label for="contextList">Paste your contexts (one per line):</label>
          <textarea id="contextList" name="contextList" placeholder="Paste specific contexts to include here..."></textarea>
          <div class="button-container"><button type="submit">Generate List</button></div>
        </div> <!-- End form-column -->

        <!-- RIGHT COLUMN -->
        <div class="info-column">
          <h2>Example Prompts</h2>
          <table><tbody><tr><td>Generate 60 contexts, live in clinicals, promoter NPS. Proportional by CSM Tier. Include 12345, 67890. Only Group & Enterprise Tiers.</td></tr><tr><td>Provide 100 contexts, live in telehealth, detractor NPS. Proportional by Time Zone. Exclude 11223, 44556, 77889.</td></tr><tr><td>Create 50 contexts, live in collector, passive NPS. Only Clinical Performance Beta Coordinator. Randomized.</td></tr><tr><td>Generate 80 contexts, live in clinicals & communicator, active NPS. Small Group Specialist CSM Team. Include 33445, 55667.</td></tr><tr><td>Provide a proportional sample of 120 contexts, live in auth management, promoter NPS. Distributed by Billing State. Include 99887, 77665, 55443.</td></tr><tr><td>Create 70 contexts, live in telehealth & collector, promoter or passive NPS. Patient Relations or Rev Cycle Beta Coordinator. Exclude 22334, 44556.</td></tr><tr><td>Generate 90 contexts, live in clinicals, passive NPS. Urgent Care or Free Clinic. Proportional sample. Include 66778, 88990.</td></tr><tr><td>Provide 55 contexts, live in telehealth & auth mgmt, promoter or detractor NPS. CSM Name Jane Smith. Exclude 11111, 22222, 33333.</td></tr><tr><td>Generate 150 contexts, live in communicator & collector, active NPS. Requires Clinical Admin/IT coordination. Representative by CSM Tier & Billing State. Include 44444, 55555, 66666.</td></tr><tr><td>Create 85 contexts, live in clinicals & telehealth, promoter or detractor NPS. Multi Specialty or Direct Primary Care. Rev Cycle or Dental Beta Coordinator. Include 77777, 88888.</td></tr></tbody></table>
        </div> <!-- End info-column -->
      </div> <!-- End columns-container -->
    </form>

    <!-- MESSAGES & RESET -->
    <div id="finalMessage"></div>
    <div id="errorMessage"></div>
    <button id="resetButton">Create another list</button>
  </div> <!-- End main-content -->

  <!-- LOADING SCREEN -->
  <div class="loading-screen" id="loadingScreen"> <div class="spinner"></div> <div class="step" id="loadingStep"></div> </div>

  <!-- LOGO -->
  <div class="logo-container" id="logo-container"> <img src="Product Operations Logo Small.png" alt="Product Operations Logo" /> </div>

  <!-- MODALS (Only keep relevant ones for this page) -->
  <div id="repSampleModal" class="modal"> <div class="modal-content"> <h3>Select Representative based on:</h3> <form id="repSampleForm"></form> <button id="repSampleConfirm" class="modal-button">Confirm</button> </div> </div>
  <!-- Removed #listModal, #searchListModal, #templateSelectModal as their functions moved -->
  <div id="scrubListModal" class="modal"> <div class="modal-content"> <h3>Scrub Existing List</h3> <form id="scrubListForm" autocomplete="off"> <div class="modal-filter-column" id="scrubFilterColumnContainer"> </div> <div class="modal-input-column"> <div> <label for="scrubUsername">Username (e.g., wwhite):</label> <input type="text" id="scrubUsername" name="scrubUsername" required> </div> <div class="file-name-container"> <div><label for="scrubFeatureNumber">Feature Number:</label><input type="text" id="scrubFeatureNumber" name="scrubFeatureNumber" placeholder="FEATURE-123" required pattern="FEATURE-\d{3,8}"></div> <div><label for="scrubStage">Stage:</label><select id="scrubStage" name="scrubStage" required><option value="Alpha">Alpha</option><option value="Beta">Beta</option><option value="DarkAlpha">DarkAlpha</option><option value="DarkBeta">DarkBeta</option><option value="AlphaBundled">AlphaBundled</option><option value="BetaBundled">BetaBundled</option><option value="AlphaBatched">AlphaBatched</option><option value="BetaBatched">BetaBatched</option></select></div> <div><label for="scrubWaveNumber">Wave Number:</label><select id="scrubWaveNumber" name="scrubWaveNumber" required><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option></select></div> </div> <div> <label for="scrubContextList">Paste Context IDs (one per line):</label> <textarea id="scrubContextList" name="scrubContextList" placeholder="Paste context IDs here..." required></textarea> </div> <div> <label>Generated Prompt (for review):</label> <div id="scrubGeneratedPrompt">Prompt will appear here as you select filters...</div> </div> <div id="scrubErrorMsg"></div> </div> </form> <div class="modal-actions"> <button class="modal-button secondary" id="cancelScrubBtn">Cancel</button> <button class="modal-button" id="scrubSubmitBtn">Submit Scrub Request</button> </div> </div> </div>

 <script>
    // --- Get Elements ---
    const promptArea = document.getElementById('var2');
    const numContextsInput = document.getElementById('numContexts');
    const featureNumberInput = document.getElementById('featureNumber');
    const contextListArea = document.getElementById('contextList');
    const repSampleCheckbox = document.getElementById('repSample');
    const repSampleModal = document.getElementById('repSampleModal');
    const repSampleForm = document.getElementById('repSampleForm');
    const repSampleConfirm = document.getElementById('repSampleConfirm');
    const form = document.getElementById('recruitmentForm');
    const finalMessageDiv = document.getElementById('finalMessage');
    const errorMessageDiv = document.getElementById('errorMessage');
    const loadingScreen = document.getElementById('loadingScreen');
    const loadingStepElem = document.getElementById('loadingStep');
    const resetButton = document.getElementById('resetButton');
    // Removed viewListsButton, listModal, listTableBody, etc.
    const scrubListButton = document.getElementById('scrubListButton');
    const scrubListModal = document.getElementById('scrubListModal');
    const scrubListForm = document.getElementById('scrubListForm');
    const scrubFilterColumnContainer = document.getElementById('scrubFilterColumnContainer');
    const scrubUsernameInput = document.getElementById('scrubUsername');
    const scrubFeatureNumberInput = document.getElementById('scrubFeatureNumber');
    const scrubStageSelect = document.getElementById('scrubStage');
    const scrubWaveNumberSelect = document.getElementById('scrubWaveNumber');
    const scrubContextListArea = document.getElementById('scrubContextList');
    const scrubGeneratedPromptDiv = document.getElementById('scrubGeneratedPrompt');
    const scrubErrorMsgDiv = document.getElementById('scrubErrorMsg');
    const cancelScrubBtn = document.getElementById('cancelScrubBtn');
    const scrubSubmitBtn = document.getElementById('scrubSubmitBtn');
    const mainFilterColumn = document.getElementById('mainFilterColumn');

    // --- Variables ---
    const defaultPrompt = "Please give me xx contexts"; let userPromptText = defaultPrompt; let repSampleSelection = []; let loadingInterval; const loadingSteps = [ "Initializing request...", "Connecting to Snowflake...", "AI is crafting your list...", "Generating SQL query...", "Executing query...", "Exporting results...", "Finalizing..." ]; let currentStep = 0; const repFilterOptions = ["CSM Tier", "CS Team", "Specialty"]; const fileNamePattern = /^FEATURE-\d{3,8}$/i;

    // --- Filter Group Configuration ---
     const filterGroups = [
        { groupId: 'csmTier-group', name: 'CSM Tier' },
        { groupId: 'csTeam-group', name: 'CS Team' },
        { groupId: 'clientRelType-group', name: 'Client Relationship Type' },
        { groupId: 'specialty-group', name: 'Specialty' },
        { groupId: 'clinicalsStatus-group', name: 'Clinicals Status' },
        { groupId: 'collectorStatus-group', name: 'Collector Status' },
        { groupId: 'communicatorStatus-group', name: 'Communicator Status' },
        { groupId: 'hospitalClinicalsStatus-group', name: 'Hospital Clinicals Status' },
        { groupId: 'hospitalCollectorStatus-group', name: 'Hospital Collector Status' },
        { groupId: 'alphaBetaStatus-group', name: 'Alpha Beta Status' }
    ];

    // --- Function Definitions ---
    function initializePrompt() { if (promptArea) promptArea.value = defaultPrompt; userPromptText = defaultPrompt; if (numContextsInput) numContextsInput.value = ''; }
    function updateBasePrompt() { const num = numContextsInput ? numContextsInput.value.trim() : ''; userPromptText = num ? `Please give me ${num} contexts` : defaultPrompt; updatePromptFilters(); }
    function formatValues(values) { if (!values || values.length === 0) return ""; if (values.length === 1) return values[0]; if (values.length === 2) return `${values[0]} and ${values[1]}`; return `${values.slice(0, -1).join(', ')}, and ${values[values.length - 1]}`; }
    function updatePromptFilters() { if (!promptArea) return; let filtersText = []; filterGroups.forEach(fg => { const group = document.getElementById(fg.groupId); if (!group) { return; } const checked = group.querySelectorAll('input[type="checkbox"]:checked'); const values = Array.from(checked).map(cb => cb.value.replace(/–/g, '-')); if (values.length > 0) { filtersText.push(`${fg.name} of ${formatValues(values)}`); } }); let newPrompt = userPromptText; if (filtersText.length > 0) { newPrompt += ` with filters: ${filtersText.join('; ')}.`; } if(repSampleCheckbox && repSampleCheckbox.checked && repSampleSelection.length > 0) { newPrompt += ` Please provide a representative sample based on ${formatValues(repSampleSelection)}.`; } if (contextListArea) { const contexts = contextListArea.value.split(/\r?\n/).map(line => line.trim()).filter(line => line && /^\d+$/.test(line)); if (contexts.length > 0) { newPrompt += ` Please include contexts: ${contexts.join(', ')}.`; } } if (featureNumberInput) { const featureNumber = featureNumberInput.value.trim().toUpperCase(); if (featureNumber && fileNamePattern.test(featureNumber)) { newPrompt += ` This is for feature number ${featureNumber}.`; } } promptArea.value = newPrompt; clearUserMessage(errorMessageDiv); }
    function populateRepSampleOptions() { if (!repSampleForm) return; repSampleForm.innerHTML = ""; repFilterOptions.forEach((option, index) => { const isChecked = repSampleSelection.includes(option); const checkboxWrapper = document.createElement('div'); checkboxWrapper.innerHTML = `<input type="checkbox" name="repOption" id="repOption${index}" value="${option}" ${isChecked ? 'checked' : ''}><label for="repOption${index}">${option}</label>`; repSampleForm.appendChild(checkboxWrapper); }); }
    function showLoading(show, message = "") { if (loadingScreen && loadingStepElem) { if (show) { loadingStepElem.textContent = message || loadingSteps[0]; loadingStepElem.classList.add('active'); loadingScreen.style.display = 'flex'; cycleLoadingSteps(); } else { loadingScreen.style.display = 'none'; clearInterval(loadingInterval); loadingStepElem.classList.remove('active'); } } else { console.error("Loading screen elements not found!"); } }
    function cycleLoadingSteps() { clearInterval(loadingInterval); currentStep = 0; if (!loadingStepElem) return; loadingStepElem.textContent = loadingSteps[currentStep]; loadingStepElem.classList.add('active'); loadingInterval = setInterval(() => { if (!loadingStepElem) { clearInterval(loadingInterval); return; }; loadingStepElem.classList.remove('active'); setTimeout(() => { if (!loadingStepElem) return; currentStep = (currentStep + 1) % loadingSteps.length; loadingStepElem.textContent = loadingSteps[currentStep]; loadingStepElem.classList.add('active'); }, 500); }, 3000); }
    function displayUserMessage(element, message, isError = true) { if (element) { element.innerHTML = message; element.style.display = 'block'; element.style.backgroundColor = isError ? '#f8d7da' : '#d4edda'; element.style.color = isError ? '#721c24' : '#155724'; element.style.border = `1px solid ${isError ? '#f5c6cb' : '#c3e6cb'}`; } else { console.error("Attempted to display message on a null element.", message); } }
    function clearUserMessage(element) { if (element) { element.textContent = ""; element.style.display = 'none'; } }
    function setupScrubFilters() { if (!scrubFilterColumnContainer || !mainFilterColumn) { console.error("Cannot setup scrub filters: Modal container or main filter column not found."); return; } const h3 = scrubFilterColumnContainer.querySelector('h3'); let h3Content = h3 ? h3.outerHTML : '<h3>Apply Filters to Your List</h3>'; scrubFilterColumnContainer.innerHTML = h3Content; filterGroups.forEach(fg => { const mainGroup = document.getElementById(fg.groupId); if (mainGroup) { try { const clonedGroup = mainGroup.cloneNode(true); scrubFilterColumnContainer.appendChild(clonedGroup); clonedGroup.querySelectorAll('input[type="checkbox"]').forEach(cb => { cb.addEventListener('change', updateScrubPrompt); }); } catch (cloneError) { console.error(`Error cloning filter group ${fg.groupId}:`, cloneError) } } else { console.warn(`Filter group ${fg.groupId} not found in main form, cannot clone for scrub modal.`); } }); }
    function updateScrubPrompt() { if (!scrubGeneratedPromptDiv || !scrubContextListArea || !scrubFeatureNumberInput || !scrubFilterColumnContainer) { console.error("Cannot update scrub prompt: Required modal elements not found."); return; } const contextsRaw = scrubContextListArea.value.trim(); const contexts = contextsRaw.split(/\r?\n/).map(line => line.trim()).filter(line => line && /^\d+$/.test(line)); let filtersText = []; filterGroups.forEach(fg => { const group = scrubFilterColumnContainer.querySelector(`#${fg.groupId}`); if (!group) { return; } const checked = group.querySelectorAll('input[type="checkbox"]:checked'); const values = Array.from(checked).map(cb => cb.value.replace(/–/g, '-')); if (values.length > 0) { filtersText.push(`${fg.name} of ${formatValues(values)}`); } }); const featureNumber = scrubFeatureNumberInput.value.trim().toUpperCase(); let newPrompt = ""; if (contexts.length > 0) { newPrompt += `For contexts: ${contexts.join(', ')}.`; } else { newPrompt += "For contexts: [Please paste contexts]."; } if (filtersText.length > 0) { newPrompt += ` Only include if: ${filtersText.join('; ')}.`; } if (featureNumber && fileNamePattern.test(featureNumber)) { newPrompt += ` This is for ${featureNumber}.`; } else { newPrompt += ` This is for [Enter Valid Feature Number].`; } scrubGeneratedPromptDiv.textContent = newPrompt; clearUserMessage(scrubErrorMsgDiv); }
    // Removed triggerBackendGeneration, getReadableTemplateName, populateTable, handleGenerateDocClick as they relate to marketing content modals

    // --- Event Listeners Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM fully loaded. Initializing script for List Tools page..."); initializePrompt();
        if (promptArea) { promptArea.addEventListener('input', () => { let baseText = promptArea.value.split(" with ")[0]; userPromptText = baseText.includes("xx contexts") ? defaultPrompt : baseText; clearUserMessage(errorMessageDiv); console.log("User prompt updated manually:", userPromptText); }); } else { console.warn("Main prompt area (#var2) not found."); }
        if (numContextsInput) { numContextsInput.addEventListener('input', updateBasePrompt); } else { console.warn("Num Contexts input (#numContexts) not found."); }
        if (featureNumberInput) { featureNumberInput.addEventListener('input', updatePromptFilters); } else { console.warn("Feature Number input (#featureNumber) not found."); }
        if (contextListArea) { contextListArea.addEventListener('input', updatePromptFilters); } else { console.warn("Context List area (#contextList) not found."); }
        filterGroups.forEach(fg => { const mainGroup = document.getElementById(fg.groupId); if (mainGroup) { mainGroup.querySelectorAll('input[type="checkbox"]').forEach(cb => { cb.addEventListener('change', updatePromptFilters); }); } else { console.warn(`Main filter group element with ID '${fg.groupId}' not found. Cannot attach listeners.`); } });
        if (form) { form.addEventListener('submit', function(e) { e.preventDefault(); console.log("Original form submitted, starting validation..."); clearUserMessage(finalMessageDiv); clearUserMessage(errorMessageDiv); const username = document.getElementById('var1')?.value?.trim(); if (!username) { displayUserMessage(errorMessageDiv, "Error: Username is required."); return; } const featureNumberElem = document.getElementById('featureNumber'); const stageElem = document.getElementById('stage'); const waveNumberElem = document.getElementById('waveNumber'); const var3Elem = document.getElementById('var3'); const var2Elem = document.getElementById('var2'); if (!featureNumberElem || !stageElem || !waveNumberElem || !var3Elem || !var2Elem) { displayUserMessage(errorMessageDiv, "Error: Critical form elements (feature, stage, wave, var3, var2) are missing."); return; } const featureNumber = featureNumberElem.value.trim().toUpperCase(); const stage = stageElem.value; const waveNumber = waveNumberElem.value; if (!fileNamePattern.test(featureNumber)) { displayUserMessage(errorMessageDiv, "Error: Feature Number must be in the format FEATURE-123... (uppercase, no spaces)."); featureNumberElem.focus(); return; } featureNumberElem.value = featureNumber; if (!stage) { displayUserMessage(errorMessageDiv, "Error: Stage selection is required."); return; } if (!waveNumber) { displayUserMessage(errorMessageDiv, "Error: Wave Number selection is required."); return; } const combinedFileName = `${featureNumber}_${stage}_${waveNumber}`; var3Elem.value = combinedFileName; const finalPrompt = var2Elem.value; if (finalPrompt.includes("xx contexts") && !(numContextsInput?.value?.trim())) { displayUserMessage(errorMessageDiv, "Error: Please specify the number of contexts either in the text box or the 'Number of Contexts' field."); numContextsInput?.focus(); return; } form.style.display = 'none'; if(resetButton) resetButton.style.display = 'none'; showLoading(true, "Submitting generation request..."); const formData = new URLSearchParams(); formData.append('var1', username); formData.append('var2', finalPrompt); formData.append('var3', combinedFileName); console.log("Sending data to /run-powershell:", formData.toString()); fetch('/run-powershell', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' }, body: formData.toString() }) .then(async response => { if (!response.ok) { const errorText = await response.text(); console.error(`Server error (${response.status}): ${errorText}`); throw new Error(errorText || `Request failed with status ${response.status}`); } return response.text(); }) .then(data => { console.log("Server responded:", data); const trimmedMessage = data.trim() || "List generation request submitted successfully."; const sharepointUrl = "https://athenahealth.sharepoint.com/:f:/s/SharedServicesProductOperations/EiEiEW_zZE9EtSPvNXCYFmEB8qfcFrcAgizY8MCFwoet5w?e=6qndL9"; const successHtml = `${trimmedMessage} <br/>The file will appear shortly in the <a href="${sharepointUrl}" target="_blank">Shared Services OneDrive folder</a>.`; displayUserMessage(finalMessageDiv, successHtml, false); if(resetButton) resetButton.style.display = 'block'; }) .catch(error => { console.error("Fetch error:", error); displayUserMessage(errorMessageDiv, `Error: ${error.message}`); if(form) form.style.display = 'block'; if(resetButton) resetButton.style.display = 'block'; }) .finally(() => { console.log("Fetch to /run-powershell completed."); showLoading(false); }); }); } else { console.error("Main recruitment form (#recruitmentForm) not found!"); }
        if (resetButton) { resetButton.addEventListener('click', () => { window.location.reload(); }); } else { console.warn("Reset button (#resetButton) not found."); }
        if (repSampleCheckbox) { repSampleCheckbox.addEventListener('change', () => { if (repSampleCheckbox.checked) { populateRepSampleOptions(); if(repSampleModal) repSampleModal.style.display = "flex"; } else { repSampleSelection = []; updatePromptFilters(); } }); } else { console.warn("Representative Sample checkbox (#repSample) not found."); }
        if (repSampleConfirm) { repSampleConfirm.addEventListener('click', () => { repSampleSelection = Array.from(document.querySelectorAll('input[name="repOption"]:checked')).map(el => el.value); updatePromptFilters(); if(repSampleModal) repSampleModal.style.display = "none"; }); } else { console.warn("Representative Sample confirm button (#repSampleConfirm) not found."); }
        if (repSampleModal) { repSampleModal.addEventListener('click', (e) => { if(e.target === repSampleModal) { repSampleModal.style.display = "none"; if(repSampleCheckbox) repSampleCheckbox.checked = repSampleSelection.length > 0; } }); } else { console.warn("Representative Sample modal (#repSampleModal) not found."); }
        if (scrubListButton) { scrubListButton.addEventListener('click', () => { setupScrubFilters(); const mainUsername = document.getElementById('var1')?.value?.trim(); if (scrubUsernameInput) scrubUsernameInput.value = mainUsername || ''; if (scrubFeatureNumberInput) scrubFeatureNumberInput.value = ''; if (scrubStageSelect) scrubStageSelect.value = 'Alpha'; if (scrubWaveNumberSelect) scrubWaveNumberSelect.value = '1'; if (scrubContextListArea) scrubContextListArea.value = ''; clearUserMessage(scrubErrorMsgDiv); updateScrubPrompt(); if (scrubListModal) scrubListModal.style.display = 'flex'; else console.error("Scrub List Modal not found!"); }); } else { console.error("Scrub List Button (#scrubListButton) not found!"); }
        if (scrubUsernameInput) scrubUsernameInput.addEventListener('input', updateScrubPrompt); if (scrubFeatureNumberInput) scrubFeatureNumberInput.addEventListener('input', updateScrubPrompt); if (scrubStageSelect) scrubStageSelect.addEventListener('change', updateScrubPrompt); if (scrubWaveNumberSelect) scrubWaveNumberSelect.addEventListener('change', updateScrubPrompt); if (scrubContextListArea) scrubContextListArea.addEventListener('input', updateScrubPrompt);
        if (cancelScrubBtn) { cancelScrubBtn.addEventListener('click', () => { if(scrubListModal) scrubListModal.style.display = 'none'; }); } else { console.warn("Cancel Scrub button (#cancelScrubBtn) not found."); }
        if (scrubListModal) { scrubListModal.addEventListener('click', (e) => { if (e.target === scrubListModal) { scrubListModal.style.display = 'none'; } }); } else { console.warn("Scrub List Modal (#scrubListModal) not found."); }
        if (scrubSubmitBtn) { scrubSubmitBtn.addEventListener('click', (e) => { e.preventDefault(); console.log("Scrub form submitted, starting validation..."); clearUserMessage(scrubErrorMsgDiv); clearUserMessage(finalMessageDiv); clearUserMessage(errorMessageDiv); const username = scrubUsernameInput?.value?.trim(); const featureNumber = scrubFeatureNumberInput?.value?.trim()?.toUpperCase(); const stage = scrubStageSelect?.value; const waveNumber = scrubWaveNumberSelect?.value; const contextList = scrubContextListArea?.value?.trim(); const generatedPrompt = scrubGeneratedPromptDiv?.textContent; let errors = []; if (!username) { errors.push("Username is required."); } if (!featureNumber) { errors.push("Feature Number is required."); } else if (!fileNamePattern.test(featureNumber)) { errors.push("Feature Number format must be FEATURE-123..."); } if (!stage) { errors.push("Stage selection is required."); } if (!waveNumber) { errors.push("Wave Number selection is required."); } if (!contextList) { errors.push("Context ID list cannot be empty."); } else { const contexts = contextList.split(/\r?\n/).map(line => line.trim()).filter(line => line); if (contexts.some(ctx => !/^\d+$/.test(ctx))) { errors.push("Context ID list contains invalid entries (must be numbers)."); } } if (!generatedPrompt || generatedPrompt.includes("[Please paste contexts]") || generatedPrompt.includes("[Enter Valid Feature Number]")) { errors.push("Ensure Context IDs are pasted and Feature Number is valid before submitting.") } if (errors.length > 0) { displayUserMessage(scrubErrorMsgDiv, `Error: ${errors.join(' ')}`); return; } if(scrubListModal) scrubListModal.style.display = 'none'; if(form) form.style.display = 'none'; if(resetButton) resetButton.style.display = 'none'; showLoading(true, "Submitting scrub request..."); const combinedFileName = `${featureNumber}_${stage}_${waveNumber}`; const formData = new URLSearchParams(); formData.append('var1', username); formData.append('var2', generatedPrompt); formData.append('var3', combinedFileName); console.log("Sending data to /run-list-filter:", formData.toString()); fetch('/run-list-filter', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' }, body: formData.toString() }) .then(async response => { if (!response.ok) { const errorText = await response.text(); console.error(`Server error (${response.status}) from /run-list-filter: ${errorText}`); throw new Error(errorText || `Request failed with status ${response.status}`); } return response.text(); }) .then(data => { console.log("Server responded from /run-list-filter:", data); const trimmedMessage = data.trim() || "List scrub request submitted successfully."; const sharepointUrl = "https://athenahealth.sharepoint.com/:f:/s/SharedServicesProductOperations/EiEiEW_zZE9EtSPvNXCYFmEB8qfcFrcAgizY8MCFwoet5w?e=6qndL9"; const successHtml = `${trimmedMessage} <br/>The scrubbed file will appear shortly in the <a href="${sharepointUrl}" target="_blank">Shared Services OneDrive folder</a>.`; displayUserMessage(finalMessageDiv, successHtml, false); if(resetButton) resetButton.style.display = 'block'; }) .catch(error => { console.error("Fetch error to /run-list-filter:", error); displayUserMessage(errorMessageDiv, `Scrub Error: ${error.message}`); if(resetButton) resetButton.style.display = 'block'; }) .finally(() => { console.log("Fetch to /run-list-filter completed."); showLoading(false); }); }); } else { console.warn("Scrub Submit button (#scrubSubmitBtn) not found."); }
        console.log("All list_tools.html event listeners attached.");
    }); // End DOMContentLoaded

 </script>
</body>
</html>